#include <stdint.h>
#include <stdio.h>
#define T85APU_SHIFT_REGISTER_SIZE 16

#include "ATtiny85APU.c"
#include "ATtiny85APU.h"

static const uint8_t megalovania[] = {
    0x27, 0x27, 0x4e, 0x00, 0x3a, 0x00, 0x00, 0x37, 0x00, 0x33, 0x00, 0x2e, 0x00, 0x27, 0x2e, 0x33, 0x23, 0x23, 0x4e, 0x00, 0x3a, 0x00, 0x00, 0x37, 0x00, 0x33, 0x00, 0x2e, 0x00, 0x27, 0x2e, 0x33, 0x21, 0x21, 0x4e, 0x00, 0x3a, 0x00, 0x00, 0x37, 0x00, 0x33, 0x00, 0x2e, 0x00, 0x27, 0x2e, 0x33, 0x1f, 0x1f, 0x4e, 0x00, 0x3a, 0x00, 0x00, 0x37, 0x00, 0x33, 0x00, 0x2e, 0x00, 0x27, 0x2e, 0x33
};

int main () {
    t85APU * apu = t85APU_new(8000000, 0, T85APU_OUTPUT_PB4);
    t85APU_setQuality(apu, 0);

    FILE * file = fopen("test.raw", "wb");

    t85APU_writeReg(apu, 0x06, 0x0B);
    t85APU_writeReg(apu, 0x09, 0x20);

    uint32_t output;

    for (int i = 0; i < sizeof(megalovania); i++) {
        t85APU_writeReg(apu, 0x00, megalovania[i]);
        t85APU_writeReg(apu, 0x10, 0xFF);
        for (int j = 0; j < 312; j++) {
            output = t85APU_calc(apu);
            fwrite(&output, sizeof(uint32_t), 1, file);
        }
        t85APU_writeReg(apu, 0x10, 0x80);
        for (int j = 0; j < 312; j++) {
            output = t85APU_calc(apu);
            fwrite(&output, sizeof(uint32_t), 1, file);
        }
    }
    fclose(file);

}